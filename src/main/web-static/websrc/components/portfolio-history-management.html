<div id="accordion-portfolio-history-management"
     class="accordion"
     hx-get="/api/portfolio/:portfolioId/history/observation"
     hx-include="[name='portfolioId']"
     hx-trigger="load"
     handlebars-template="template-portfolio-history-management"
>
</div>

<script id="template-portfolio-history-management" type="text/x-handlebars-template">

    {{#each .}}

        <div class="accordion-item">

            <h2 class="accordion-header"
                data-bs-parent="#accordion-portfolio-history-management"
                hx-include="[name='portfolioId']"
                hx-target="#portfolio-allocation-management-rows-{{id}}"
                hx-trigger="click"
                handlebars-template="template-portfolio-history-management-rows"
                hx-get="/api/portfolio/:portfolioId/history?observationTimestampId={{id}}"
            >
            <button class="accordion-button collapsed"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#portfolio-allocation-management-{{id}}"
                    aria-expanded="true"
                    aria-controls="portfolio-allocation-management-{{id}}"
            >
                {{timeTag}}
            </button>
            </h2>

            <div id="portfolio-allocation-management-{{id}}" class="accordion-collapse collapse">
                <div class="accordion-body row justify-content-center">

                    <form hx-post="/api/test" hx-ext="form-json">
                        <table class="table table-striped">

                            <thead class="sticky-header">
                            <tr>
                                <th scope="col" colspan="2">Asset</th>
                                <th scope="col">Class</th>
                                <th scope="col" class="w-10">Cash reserve?</th>
                                <th scope="col" class="w-15">Quantity</th>
                                <th scope="col" class="w-15">Market price</th>
                                <th scope="col" class="w-12">Total market value</th>
                                <th scope="col"></th>
                            </tr>
                            </thead>

                            <tbody class="table-group-divider" id="portfolio-allocation-management-rows-{{id}}">
                            </tbody>

                            <tfoot class="sticky-footer">
                            <tr>
                                <td colspan="8">
                                    <div class="d-flex w-100">
                                        <button class="btn btn-secondary"
                                                type="button"
                                                onclick="addPortfolioHistoryManagementRow({{id}})"
                                        >
                                            <span class="bi bi-plus-circle h5"></span>
                                        </button>
                                        <button class="btn btn-primary ms-auto" type="submit">
                                            <span class="bi bi-save-fill h5"></span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            </tfoot>

                        </table>
                    </form>

                </div>
            </div>

        </div>

    {{/each}}

</script>

<script id="template-portfolio-history-management-rows" type="text/x-handlebars-template">

    {{#each @root.[0].allocations}}
        {{> template-portfolio-history-management-row allocationIndex=@index observationTimestampId=@root.[0].observationTimestamp.id }}
    {{/each}}

</script>

<script id="template-portfolio-history-management-row" type="text/x-handlebars-template">

    <tr>
        <td>

            <input id="asset-id-input-alloc-{{allocationIndex}}-obs-{{observationTimestampId}}"
                   type="hidden"
                   name="allocations[{{allocationIndex}}][assetId]"
                   value="{{assetId}}"
            />

            {{#if assetId}}
                {{assetTicker}}
            {{else}}

                <div class="input-group">

                    <input id="asset-ticker-input-alloc-{{allocationIndex}}-obs-{{observationTimestampId}}"
                           type="text"
                           name="allocations[{{allocationIndex}}][assetTicker]"
                           placeholder="Asset ticker"
                           aria-label="Asset ticker"
                           autocomplete="off"
                           class="form-control"
                           value="{{assetTicker}}"
                           list="datalist-assets"
                           hx-validate="true"
                           hx-on::validation:validate="validateAssetTicker({{allocationIndex}}, {{observationTimestampId}})"
                    />
                    <button id="asset-ticker-button-alloc-{{allocationIndex}}-obs-{{observationTimestampId}}"
                            type="button"
                            class="btn btn-primary btn-xs"
                            onclick="assetButtonActionClickHandler({{allocationIndex}}, {{observationTimestampId}})"
                    >
                        <span class="bi bi-search"></span>
                    </button>

                </div>

                <div class="form-text"
                     id="asset-ticker-message-alloc-{{allocationIndex}}-obs-{{observationTimestampId}}"
                     style="display: none"
                >
                    * Inserting new asset
                </div>

            {{/if}}

        </td>

        <td>

            {{#if assetName}}
                {{assetName}}
            {{else}}
                <input id="asset-name-input-alloc-{{allocationIndex}}-obs-{{observationTimestampId}}"
                       type="text"
                       name="allocations[{{allocationIndex}}][assetName]"
                       placeholder="Asset name"
                       aria-label="Asset name"
                       autocomplete="off"
                       class="form-control"
                       value="{{assetName}}"
                       style="display: none"
                />
            {{/if}}

        </td>

        <td>
            <input type="text"
                   name="allocations[{{allocationIndex}}][class]"
                   placeholder="Class"
                   aria-label="Class"
                   autocomplete="off"
                   class="form-control"
                   value="{{class}}"
                   list="datalist-classes"
                   oninput="maskTagInput(this)"
                   required
            />
        </td>

        <td class="align-middle text-center">
            <input type="checkbox"
                   name="allocations[{{allocationIndex}}][cashReserve]"
                   {{#if cashReserve}}checked{{/if}}
            />
        </td>

        <td>
            <input type="number"
                   name="allocations[{{allocationIndex}}][assetQuantity]"
                   placeholder="Quantity"
                   aria-label="Quantity"
                   autocomplete="off"
                   class="form-control"
                   value="{{assetQuantity}}"
                   step="any"
                   min="0"
            />
        </td>

        <td>
            <input type="number"
                   name="allocations[{{allocationIndex}}][assetMarketPrice]"
                   placeholder="Market price"
                   aria-label="Market price"
                   autocomplete="off"
                   class="form-control"
                   value="{{assetMarketPrice}}"
                   step="any"
                   min="0"
            />
        </td>

        <td>
            <input type="number"
                   name="allocations[{{allocationIndex}}][totalMarketValue]"
                   placeholder="Total market value"
                   aria-label="Total market value"
                   autocomplete="off"
                   class="form-control "
                   value="{{totalMarketValue}}"
                   min="0"
                   required
            />
        </td>

        <td>
            <button type="button"
                    class="btn btn-danger btn-xs"
                    onclick="this.closest('tr').remove()"
            >
                <span class="bi bi-dash-circle"></span>
            </button>
        </td>

    </tr>

</script>

<script type="text/javascript">

    HandlebarsUtils.registerPartialToContainer(
        "accordion-portfolio-history",
        "template-portfolio-history-management-row"
    );

    var handlebarPortfolioHistoryManagementRowTemplate = Handlebars.compile(window["template-portfolio-history-management-row"].innerHTML);

</script>

<script type="module">

    const portfolioAllocationManagementTBodyPrefix = "portfolio-allocation-management-rows-";

    // Authored by: GitHub Copilot
    window.addPortfolioHistoryManagementRow = (observationTimestampId) => {

        const tbodyId = portfolioAllocationManagementTBodyPrefix + observationTimestampId
        const tbody = window[tbodyId];
        const nextIndex = getNextPortfolioHistoryManagementIndex(observationTimestampId);
        const newRowHtml = handlebarPortfolioHistoryManagementRowTemplate({
            allocationIndex: nextIndex,
            observationTimestampId: observationTimestampId
        });

        tbody.insertAdjacentHTML("beforeend", newRowHtml);

        // Find the first input field in the newly added row and focus it
        const firstInputFieldName = `allocations[${nextIndex}][assetTicker]`;
        const firstInputField = tbody.querySelector(`input[name="${firstInputFieldName}"]`);

        if (firstInputField) {
            firstInputField.scrollIntoView({behavior: 'smooth', block: 'center'});
            firstInputField.focus();
        }

        // Process the newly added row with htmx to enable validation
        const newRow = tbody.lastElementChild;
        htmx.process(newRow);
    }

    function getNextPortfolioHistoryManagementIndex(observationTimestampId) {
        const tbody = window[portfolioAllocationManagementTBodyPrefix + observationTimestampId];
        const rows = tbody.querySelectorAll("tr");
        return rows.length;
    }

    const assetActionButtonIdentities = {
        search: {
            classes: "btn btn-primary btn-xs",
            iconClasses: "bi bi-search"
        },
        reset: {
            classes: "btn btn-danger btn-xs",
            iconClasses: "bi bi-x-circle"
        }
    }

    window.assetButtonActionClickHandler = (index, observationTimestampId) => {

        const actionButton = window[`asset-ticker-button-alloc-${index}-obs-${observationTimestampId}`];
        const rowAssetElements = {
            actionButton,
            assetTickerInput: window[`asset-ticker-input-alloc-${index}-obs-${observationTimestampId}`],
            assetTickerMessage: window[`asset-ticker-message-alloc-${index}-obs-${observationTimestampId}`],
            assetNameInput: window[`asset-name-input-alloc-${index}-obs-${observationTimestampId}`],
            assetIdInput: window[`asset-id-input-alloc-${index}-obs-${observationTimestampId}`]
        };

        if (actionButton.className === assetActionButtonIdentities.search.classes) {
            getAsset(index, rowAssetElements);
        } else if (actionButton.className === assetActionButtonIdentities.reset.classes) {
            resetAsset(rowAssetElements);
        }
    }

    function getAsset(index, rowAssetElements) {

        const {assetTickerInput, assetNameInput, assetIdInput, assetTickerMessage} = rowAssetElements;

        assetTickerInput.setCustomValidity("");
        assetTickerInput.reportValidity();

        const assetTicker = assetTickerInput.value;
        if (!assetTicker) {
            assetTickerInput.setCustomValidity("Required for search");
            assetTickerInput.reportValidity();
            return;
        }

        fetch("/api/asset/" + assetTicker)
            .then(response => {
                if (!response.ok) {
                    const error = new Error("Network response was not ok");
                    error.response = response;
                    throw error;
                }
                return response;
            })
            .then(response => response.json())
            .then(jsonBody => {
                switchAssetActionButtonIdentity(rowAssetElements, assetActionButtonIdentities.reset);
                assetTickerInput.readOnly = true;
                assetTickerInput.value = jsonBody.ticker;
                assetNameInput.style.display = "";
                assetNameInput.readOnly = true;
                assetNameInput.value = jsonBody.name;
                assetIdInput.value = jsonBody.id;
                assetTickerMessage.style.display = "none";
            })
            .catch(error => {

                const response = error.response;

                const contentType = response.headers.get("content-type");

                if (contentType && contentType.includes("application/json")) {
                    response.json().then(jsonBody => {
                        if (jsonBody.errorMessage === "Data not found") {
                            switchAssetActionButtonIdentity(rowAssetElements, assetActionButtonIdentities.reset);
                            assetTickerInput.readOnly = false;
                            assetNameInput.style.display = "";
                            assetNameInput.readOnly = false;
                            assetNameInput.required = "required";
                            assetTickerMessage.style.display = ""
                        }
                    })

                } else {
                    // TODO add toast for errors
                    console.error("Error fetching asset:", error);
                }


            });
    }

    function switchAssetActionButtonIdentity(rowAssetElements, identity) {
        const {actionButton} = rowAssetElements;
        actionButton.className = identity.classes;
        actionButton.innerHTML = `<span class="${identity.iconClasses}"></span>`;
    }

    function resetAsset(rowAssetElements) {
        const {assetTickerInput, assetNameInput, assetIdInput, assetTickerMessage} = rowAssetElements;
        assetTickerInput.value = "";
        assetTickerInput.focus();
        assetTickerInput.readOnly = false;
        assetNameInput.value = "";
        assetNameInput.style.display = "none";
        assetNameInput.readOnly = false;
        assetNameInput.required = ""
        assetIdInput.value = "";
        assetTickerMessage.style.display = "none";
        switchAssetActionButtonIdentity(rowAssetElements, assetActionButtonIdentities.search);
    }

    window.validateAssetTicker = (allocationIndex, observationTimestampId) => {
        const assetTickerButton = window[`asset-ticker-button-alloc-${allocationIndex}-obs-${observationTimestampId}`];
        const assetTickerInput = window[`asset-ticker-input-alloc-${allocationIndex}-obs-${observationTimestampId}`];
        if (assetTickerButton.className === assetActionButtonIdentities.search.classes) {
            assetTickerInput.setCustomValidity("Reference an existing asset or create a new one");
            assetTickerInput.reportValidity();
        }
    }

</script>