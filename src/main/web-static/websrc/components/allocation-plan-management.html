<!-- TODO add button functionality -->
<button type="button"
        class="btn btn-secondary mb-2"
        onclick=""
>
    <span class="h2 bi bi-pie-chart-fill"></span>
</button>

<div class="card border-dark mb-3">

    <div class="card-header">Manage allocation plan data</div>

    <div class="card-body">
        <!-- TODO add a trigger on route to reload the allocation plans when navigating back to this component -->
        <div id="accordion-allocation-plan-management"
             class="accordion container-fluid"
             hx-get="/api/portfolio/:portfolioId/allocation-plan"
             hx-include="[name='portfolioId']"
             hx-trigger="load, reload-allocation-plan-management"
             handlebars-template="template-allocation-plan-management"
             data-hx-transform-response="mapToCompleteAllocationPlans"
             data-hx-transform-response-on-route-matching="^\/api\/portfolio\/.+\/allocation\-plan$"
        >
        </div>
    </div>

</div>

<script id="template-allocation-plan-management" type="text/x-handlebars-template">

    {{#each  @root.completeAllocationPlans}}

        <div id="allocation-plan-management-container-{{allocationPlan.id}}" class="accordion-item">

            <h2 id="allocation-plan-management-trigger-{{allocationPlan.id}}" class="accordion-header">
                <button class="accordion-button collapsed"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#allocation-plan-management-{{allocationPlan.id}}"
                        aria-expanded="true"
                        aria-controls="allocation-plan-management-{{allocationPlan.id}}"
                >
                    {{#if allocationPlan.id}}
                        {{allocationPlan.name}}
                    {{else}}
                        <!-- TODO mask oninput -->
                        <input type="text"
                               placeholder="New allocation plan *"
                               aria-label="New allocation plan name"
                               autocomplete="off"
                               class="form-control me-3"
                               oninput=""
                               onkeyup="event.preventDefault()"
                        />
                    {{/if}}
                </button>
            </h2>

            <div id="allocation-plan-management-{{allocationPlan.id}}"
                 class="accordion-collapse collapse"
                 data-bs-parent="#accordion-allocation-plan-management"
            >
                <div class="accordion-body row justify-content-center">

                    <!-- TODO after request, reload -->
                    <form id="allocation-plan-management-form-{{id}}"
                          class="needs-validation"
                          hx-post="/api/portfolio/:portfolioId/allocation-plan"
                          hx-ext="form-json"
                          hx-on::after-request=""
                    >

                        <input type="hidden" name="id" value="{{allocationPlan.id}}" />
                        {{#unless allocationPlan.id}}<input type="hidden" name="name" />{{/unless}}
                        <input type="hidden" name="type" value="ALLOCATION_PLAN" />

                        <table class="table table-striped">

                            <thead class="sticky-header">
                            <tr>
                                {{#eachReverse @root.portfolio.allocationStructure.hierarchy}}
                                    <th scope="col" {{#ifEquals field "assetTicker"}}colspan="2"{{/ifEquals}}>
                                        {{name}}
                                    </th>
                                {{/eachReverse}}
                                <th scope="col" class="w-10">Cash reserve?</th>
                                <th scope="col" class="w-15">Slice size (%)</th>
                            </tr>
                            </thead>

                            <tbody class="table-group-divider">

                            {{iteratorInit "plannedAllocationIndex"}}

                            {{#each fractalHierarchicalPlan.topAllocations}}

                                {{> template-allocation-plan-management-form-tbody-row
                                        fractalPlannedAllocation=.
                                        hierarchy=@root.portfolio.allocationStructure.hierarchy
                                        allocationIndex=(iteratorNext "plannedAllocationIndex")
                                        targetLevel=../fractalHierarchicalPlan.subLevel
                                }}

                            {{/each}}

                            </tbody>

                        </table>

                    </form>
                </div>
            </div>

        </div>

    {{/each}}

</script>

<script id="template-allocation-plan-management-form-tbody-row" type="text/x-handlebars-template">

    <tr id="allocation-plan-management-row-{{allocationIndex}}">

        {{#eachReverse hierarchy}}

            {{#ifEquals (comparator index ../targetLevel.index) -1}}

                {{#ifEquals field "assetTicker"}}
                    <td></td>
                    <td></td>
                {{else}}
                    <td></td>
                {{/ifEquals}}
                
            {{else}}

                {{#ifEquals field "assetTicker"}}

                    <!-- TODO add handlers to actions -->
                    {{> asset-composed-columns-input
                            assetId=../allocation.asset.id
                            assetTicker=../allocation.asset.ticker
                            assetName=../allocation.asset.name
                            assetIdHiddenFieldName=(concat "details[" ../allocationIndex "][asset][id]")
                            assetTickerFieldName=(concat "details[" ../allocationIndex "][asset][name]")
                            assetNameFieldName=(concat "details[" ../allocationIndex "][asset][ticker]")
                            assetTickerFieldHTMXOnValidate=""
                            assetActionButtonOnClick=""
                    }}

                    <!-- TODO Copy ticker to here before posting -->
                    <input type="hidden"
                           name="details[{{../allocationIndex}}][hierarchicalId][{{@key}}]"
                           value="{{../targetLevelKey}}"
                    />

                {{else}}

                    {{#ifEquals (comparator index ../targetLevel.index) 0}}

                        <td>
                            <input type="text"
                                   name="details[{{../allocationIndex}}][hierarchicalId][{{@key}}]"
                                   placeholder="Class"
                                   aria-label="Class"
                                   autocomplete="off"
                                   class="form-control"
                                   value="{{../targetLevelKey}}"
                                   list="datalist-classes"
                                   oninput="maskTagInput(this)"
                                   required
                            />
                        </td>

                    {{else}}

                        <td>
                            {{lookup ../allocation.hierarchicalId @key}}

                            <input type="hidden"
                                   name="details[{{../allocationIndex}}][hierarchicalId][{{@key}}]"
                                   value="{{lookup ../allocation.hierarchicalId @key}}"
                            />
                        </td>

                    {{/ifEquals}}

                {{/ifEquals}}

            {{/ifEquals}}

        {{/eachReverse}}

        <td class="align-middle text-center">
            <input type="checkbox"
                   name="details[{{allocationIndex}}][cashReserve]"
                   {{#if fractalPlannedAllocation.allocation.cashReserve}}checked{{/if}}
            />
        </td>

        <td>

            <!-- TODO mask oninput -->
            <input type="number"
                   name="details[{{allocationIndex}}][sliceSizePercentage]"
                   placeholder="Slice size %"
                   aria-label="Slice size percentage"
                   autocomplete="off"
                   class="form-control"
                   value="{{fractalPlannedAllocation.allocation.sliceSizePercentage}}"
                   step="any"
                   min="0"
                   data-null-if-empty
                   oninput=""
            />
        </td>

    </tr>

    {{#if subLevel}}

        {{#each subAllocations}}

            {{> template-allocation-plan-management-form-tbody-row
                    fractalPlannedAllocation=.
                    hierarchy=../hierarchy
                    allocationIndex=(iteratorNext "plannedAllocationIndex")
                    targetLevel=../subLevel
            }}

        {{/each}}

    {{/if}}

</script>

<script>

    HandlebarsUtils.registerPartialToContainer(
        "accordion-allocation-plan",
        "template-allocation-plan-management-form-tbody-row"
    );

</script>