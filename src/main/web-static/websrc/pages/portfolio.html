<div id="portfolio-context"
     class="row justify-content-center align-items-center row-cols-auto my-5"
     hx-get="/api/portfolio/:portfolioId"
     hx-trigger="load once, reload-portfolio"
     handlebars-template="portfolio-data"
     hx-on-htmx-after-settle="preFillEditPortfolioForm()"
></div>

<script id="portfolio-data" type="text/x-handlebars-template">
    <span class="h2"><span class="badge text-bg-secondary">{{name}}</span></span>
    <button type="button" class="btn btn-outline-primary mb-1" data-navigate-to="/portfolio/:portfolioId/edit">
        <span class="bi bi-pen h5"></span>
    </button>
    <input type="hidden" name="portfolioId" value="{{id}}" autocomplete="portfolioId" />
    <input type="hidden" name="portfolioName" value="{{name}}" autocomplete="portfolioName" />
    {{{ domJSON "portfolio" this }}}
</script>

<div id="datalist-container">

    <datalist id="datalist-classes"
              hx-get="/api/portfolio/:portfolioId/allocation-classes"
              hx-trigger="load once, load-classes"
              handlebars-template="template-monovalue-datalist"
              hx-sync="#portfolio-context:queue"
    >
    </datalist>

    <datalist id="datalist-assets"
              hx-get="/api/asset"
              hx-trigger="load once, load-assets"
              handlebars-template="template-asset-datalist"
              data-assets-initialized="false"
    >
    </datalist>

</div>

<div data-exclusive-display-container>
    <div data-display-on-regexp-route="portfolio\/([0-9]+)\/?(history|allocation\-map|allocation|$)"
         style="display: none"
    >
        <div class="row justify-content-center align-items-center row-cols-auto my-5">
            <div class="col" hx-get="/websrc/components/portfolio-navigation.html" hx-trigger="load"></div>
        </div>

        <div class="row justify-content-center align-items-center"
             data-exclusive-display-container
        >
            <div class="col"
                 data-hx-trigger-on-route="/portfolio/:portfolioId/history/*!load-portfolio"
                 data-display-on-route="/portfolio/:portfolioId/history/*"
                 hx-get="/websrc/components/portfolio-history.html"
                 hx-trigger="load-portfolio once"
                 style="display: none"
            ></div>
            <div class="col"
                 data-hx-trigger-on-route="/portfolio\/:portfolioId\/allocation($|\/.*$)!load-allocation"
                 data-display-on-route="/portfolio\/:portfolioId\/allocation($|\/.*$)"
                 hx-get="/websrc/components/allocation-plan.html"
                 hx-trigger="load-allocation once"
                 style="display: none"
            ></div>
            <div class="col"
                 data-hx-trigger-on-route="/portfolio/:portfolioId/allocation-map!load-allocation-map"
                 data-display-on-route="/portfolio/:portfolioId/allocation-map"
                 hx-get="/websrc/components/allocation-map.html"
                 hx-trigger="load-allocation-map once"
                 style="display: none"
            ></div>
        </div>
    </div>

    <div class="row justify-content-center align-items-stretch row-cols-auto my-5"
         style="display: none"
         data-display-on-route="/portfolio/:portfolioId/edit"
    >
        <div class="col">
            <div class="card portfolio-card border">

                <div class="card-header">
                    <span>Edit portfolio</span>
                </div>

                <form id="edit-portfolio-form"
                      class="needs-validation"
                      hx-put="/api/portfolio"
                      hx-ext="form-json"
                      hx-validate="true"
                      hx-swap="none"
                      hx-on::after-request="reloadPortfolio(event)"
                >
                    <div class="card-body">

                        <input type="hidden" name="id" />

                        <input type="text"
                               name="name"
                               class="form-control"
                               placeholder="Name"
                               aria-label="Name"
                               required
                               autocomplete="off"
                        />

                    </div>
                    <div class="card-footer text-end">
                        <button type="button" class="btn btn-secondary" data-navigate-to="/portfolio/:portfolioId">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>

                <script type="text/javascript">

                    function reloadPortfolio(event) {

                        if (!event.detail?.successful) {
                            return;
                        }

                        const requestConfig = event.detail?.requestConfig;
                        const form = event.target;
                        const portfolioId =
                            (requestConfig?.parameters && (requestConfig.parameters.id ?? requestConfig.parameters["id"])) ??
                            new FormData(form).get("id");

                        if (form.checkValidity() && portfolioId) {

                            form.reset();

                            const portfolioElement = document.querySelector("#portfolio-context");
                            htmx.trigger(portfolioElement, "reload-portfolio", {
                                routerPathData: {
                                    portfolioId: portfolioId
                                }
                            });

                            navigateTo(`/portfolio/${portfolioId}`);
                        }
                    }

                    function preFillEditPortfolioForm() {

                        const portfolioDataElement = document.querySelector("#portfolio-context");
                        const portfolioIdField = portfolioDataElement.querySelector("input[name='portfolioId']");
                        const portfolionNameField = portfolioDataElement.querySelector("input[name='portfolioName']");

                        const portfolioId = portfolioIdField.value;
                        const portfolionName = portfolionNameField.value;

                        const editPortfolioForm = document.querySelector("#edit-portfolio-form");
                        const editPortfolioIdInput = editPortfolioForm.querySelector("input[name='id']");
                        editPortfolioIdInput.value = portfolioId;
                        const editPortfolioNameInput = editPortfolioForm.querySelector("input[name='name']");
                        editPortfolioNameInput.value = portfolionName;
                    }

                </script>

            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    function setTextContentWithTopHierarchyName(elementIdPrefix) {

        const portfolioDataELement = document.querySelector("#portfolio-context #portfolio");
        const portfolio = JSON.parse(portfolioDataELement.textContent);
        const hierarchy = portfolio.allocationStructure.hierarchy;

        const hierarchyLevelElements = document.querySelectorAll(elementIdPrefix);
        for (const element of hierarchyLevelElements) {
            element.textContent = hierarchy.at(-1).name;
        }
    }

</script>

<script id="template-monovalue-datalist" type="text/x-handlebars-template">

    {{#each .}}

        {{#if (getProperty this ../propertyKey) }}
            <option value="{{getProperty this ../propertyKey}}">{{getProperty this ../propertyKey}}</option>
        {{else}}
            <option value="{{this}}">{{this}}</option>
        {{/if}}

    {{/each}}

</script>

<script id="template-asset-datalist" type="text/x-handlebars-template">

    {{> template-monovalue-datalist propertyKey="ticker"}}

</script>

<script id="asset-composed-columns-input" type="text/x-handlebars-template">

    <td>

        <input type="hidden"
               name="{{assetIdHiddenFieldName}}"
               value="{{assetId}}"
               data-null-if-empty
        />

        {{#if assetId}}
            {{assetTicker}}
        {{else}}

            <div class="input-group">

                <input type="text"
                       name="{{assetTickerFieldName}}"
                       placeholder="Asset ticker"
                       aria-label="Asset ticker"
                       autocomplete="off"
                       class="form-control"
                       value="{{assetTicker}}"
                       list="datalist-assets"
                       hx-validate="true"
                       hx-on::validation:validate="{{assetTickerFieldHTMXOnValidate}}"
                       oninput="maskTickerInput(this)"
                />
                <button data-asset-action-button
                        type="button"
                        class="btn btn-primary btn-xs"
                        onclick="{{assetActionButtonOnClick}}"
                >
                    <span class="bi bi-search"></span>
                </button>

            </div>

            <div data-new-asset-ticker-message
                 class="form-text"
                 style="display: none"
            >
                * Creating new asset
            </div>

            <div data-asset-ticker-extra-error-message="{{assetTickerFieldName}}" class="invalid-feedback"></div>

        {{/if}}

    </td>

    <td>

        {{#if assetName}}
            {{assetName}}
        {{else}}
            <input type="text"
                   name="{{assetNameFieldName}}"
                   placeholder="Asset name"
                   aria-label="Asset name"
                   autocomplete="off"
                   class="form-control"
                   value="{{assetName}}"
                   style="display: none"
            />
        {{/if}}

    </td>

</script>

<script type="text/javascript">

    HandlebarsUtils.registerPartialToContainer(
        "datalist-container",
        "template-monovalue-datalist"
    );

    HandlebarsUtils.registerPartialToContainer(
        "datalist-container",
        "template-asset-datalist"
    );

    HandlebarsUtils.registerPartialToContainer(
        "datalist-container",
        "asset-composed-columns-input"
    );

</script>